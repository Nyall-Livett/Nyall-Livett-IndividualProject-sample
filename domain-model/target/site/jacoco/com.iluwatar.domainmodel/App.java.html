<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">domain-model</a> &gt; <a href="index.source.html" class="el_package">com.iluwatar.domainmodel</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">/*
 * This project is licensed under the MIT license. Module model-view-viewmodel is using ZK framework licensed under LGPL (see lgpl-3.0.txt).
 *
 * The MIT License
 * Copyright © 2014-2022 Ilkka Seppälä
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package com.iluwatar.domainmodel;

import static org.joda.money.CurrencyUnit.USD;

import java.sql.SQLException;
import java.time.LocalDate;
import javax.sql.DataSource;
import org.h2.jdbcx.JdbcDataSource;
import org.joda.money.Money;


/**
 * Domain Model pattern is a more complex solution for organizing domain logic than Transaction
 * Script and Table Module. It provides an object-oriented way of dealing with complicated logic.
 * Instead of having one procedure that handles all business logic for a user action like
 * Transaction Script there are multiple objects and each of them handles a slice of domain logic
 * that is relevant to it. The significant difference between Domain Model and Table Module pattern
 * is that in Table Module a single class encapsulates all the domain logic for all records stored
 * in table when in Domain Model every single class represents only one record in underlying table.
 *
 * &lt;p&gt;In this example, we will use the Domain Model pattern to implement buying of products
 * by customers in a Shop. The main method will create a customer and a few products.
 * Customer will do a few purchases, try to buy product which are too expensive for him,
 * return product which he bought to return money.&lt;/p&gt;
 */
<span class="nc" id="L50">public class App {</span>

  public static final String H2_DB_URL = &quot;jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1&quot;;

  public static final String CREATE_SCHEMA_SQL =
      &quot;CREATE TABLE CUSTOMERS (name varchar primary key, money decimal);&quot;
          + &quot;CREATE TABLE PRODUCTS (name varchar primary key, price decimal, expiration_date date);&quot;
          + &quot;CREATE TABLE PURCHASES (&quot;
          + &quot;product_name varchar references PRODUCTS(name),&quot;
          + &quot;customer_name varchar references CUSTOMERS(name));&quot;;

  public static final String DELETE_SCHEMA_SQL =
      &quot;DROP TABLE PURCHASES IF EXISTS;&quot;
          + &quot;DROP TABLE CUSTOMERS IF EXISTS;&quot;
          + &quot;DROP TABLE PRODUCTS IF EXISTS;&quot;;

  /**
   * Program entry point.
   *
   * @param args command line arguments
   * @throws Exception if any error occurs
   */
  public static void main(String[] args) throws Exception {

    // Create data source and create the customers, products and purchases tables
<span class="fc" id="L75">    final var dataSource = createDataSource();</span>
<span class="fc" id="L76">    deleteSchema(dataSource);</span>
<span class="fc" id="L77">    createSchema(dataSource);</span>

    // create customer
<span class="fc" id="L80">    var customerDao = new CustomerDaoImpl(dataSource);</span>

    var tom =
<span class="fc" id="L83">        Customer.builder()</span>
<span class="fc" id="L84">            .name(&quot;Tom&quot;)</span>
<span class="fc" id="L85">            .money(Money.of(USD, 30))</span>
<span class="fc" id="L86">            .customerDao(customerDao)</span>
<span class="fc" id="L87">            .build();</span>

<span class="fc" id="L89">    tom.save();</span>

    // create products
<span class="fc" id="L92">    var productDao = new ProductDaoImpl(dataSource);</span>

    var eggs =
<span class="fc" id="L95">        Product.builder()</span>
<span class="fc" id="L96">            .name(&quot;Eggs&quot;)</span>
<span class="fc" id="L97">            .price(Money.of(USD, 10.0))</span>
<span class="fc" id="L98">            .expirationDate(LocalDate.now().plusDays(7))</span>
<span class="fc" id="L99">            .productDao(productDao)</span>
<span class="fc" id="L100">            .build();</span>

    var butter =
<span class="fc" id="L103">        Product.builder()</span>
<span class="fc" id="L104">            .name(&quot;Butter&quot;)</span>
<span class="fc" id="L105">            .price(Money.of(USD, 20.00))</span>
<span class="fc" id="L106">            .expirationDate(LocalDate.now().plusDays(9))</span>
<span class="fc" id="L107">            .productDao(productDao)</span>
<span class="fc" id="L108">            .build();</span>

    var cheese =
<span class="fc" id="L111">        Product.builder()</span>
<span class="fc" id="L112">            .name(&quot;Cheese&quot;)</span>
<span class="fc" id="L113">            .price(Money.of(USD, 25.0))</span>
<span class="fc" id="L114">            .expirationDate(LocalDate.now().plusDays(2))</span>
<span class="fc" id="L115">            .productDao(productDao)</span>
<span class="fc" id="L116">            .build();</span>

<span class="fc" id="L118">    eggs.save();</span>
<span class="fc" id="L119">    butter.save();</span>
<span class="fc" id="L120">    cheese.save();</span>

    // show money balance of customer after each purchase
<span class="fc" id="L123">    tom.showBalance();</span>
<span class="fc" id="L124">    tom.showPurchases();</span>

    // buy eggs
<span class="fc" id="L127">    tom.buyProduct(eggs);</span>
<span class="fc" id="L128">    tom.showBalance();</span>

    // buy butter
<span class="fc" id="L131">    tom.buyProduct(butter);</span>
<span class="fc" id="L132">    tom.showBalance();</span>

    // trying to buy cheese, but receive a refusal
    // because he didn't have enough money
<span class="fc" id="L136">    tom.buyProduct(cheese);</span>
<span class="fc" id="L137">    tom.showBalance();</span>

    // return butter and get money back
<span class="fc" id="L140">    tom.returnProduct(butter);</span>
<span class="fc" id="L141">    tom.showBalance();</span>

    // Tom can buy cheese now because he has enough money
    // and there is a discount on cheese because it expires in 2 days
<span class="fc" id="L145">    tom.buyProduct(cheese);</span>

<span class="fc" id="L147">    tom.save();</span>

    // show money balance and purchases after shopping
<span class="fc" id="L150">    tom.showBalance();</span>
<span class="fc" id="L151">    tom.showPurchases();</span>
<span class="fc" id="L152">  }</span>

  private static DataSource createDataSource() {
<span class="fc" id="L155">    var dataSource = new JdbcDataSource();</span>
<span class="fc" id="L156">    dataSource.setUrl(H2_DB_URL);</span>
<span class="fc" id="L157">    return dataSource;</span>
  }

  private static void deleteSchema(DataSource dataSource) throws SQLException {
<span class="fc" id="L161">    try (var connection = dataSource.getConnection();</span>
<span class="fc" id="L162">        var statement = connection.createStatement()) {</span>
<span class="fc" id="L163">      statement.execute(DELETE_SCHEMA_SQL);</span>
    }
<span class="fc" id="L165">  }</span>

  private static void createSchema(DataSource dataSource) throws SQLException {
<span class="fc" id="L168">    try (var connection = dataSource.getConnection();</span>
<span class="fc" id="L169">        var statement = connection.createStatement()) {</span>
<span class="fc" id="L170">      statement.execute(CREATE_SCHEMA_SQL);</span>
    }
<span class="fc" id="L172">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>