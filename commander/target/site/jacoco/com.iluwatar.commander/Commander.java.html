<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Commander.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">commander</a> &gt; <a href="index.source.html" class="el_package">com.iluwatar.commander</a> &gt; <span class="el_source">Commander.java</span></div><h1>Commander.java</h1><pre class="source lang-java linenums">/*
 * This project is licensed under the MIT license. Module model-view-viewmodel is using ZK framework licensed under LGPL (see lgpl-3.0.txt).
 *
 * The MIT License
 * Copyright © 2014-2022 Ilkka Seppälä
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package com.iluwatar.commander;

import com.iluwatar.commander.Order.MessageSent;
import com.iluwatar.commander.Order.PaymentStatus;
import com.iluwatar.commander.employeehandle.EmployeeHandle;
import com.iluwatar.commander.exceptions.DatabaseUnavailableException;
import com.iluwatar.commander.exceptions.ItemUnavailableException;
import com.iluwatar.commander.exceptions.PaymentDetailsErrorException;
import com.iluwatar.commander.exceptions.ShippingNotPossibleException;
import com.iluwatar.commander.messagingservice.MessagingService;
import com.iluwatar.commander.paymentservice.PaymentService;
import com.iluwatar.commander.queue.QueueDatabase;
import com.iluwatar.commander.queue.QueueTask;
import com.iluwatar.commander.queue.QueueTask.TaskType;
import com.iluwatar.commander.shippingservice.ShippingService;
import java.util.List;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


/**
 * &lt;p&gt;Commander pattern is used to handle all issues that can come up while making a
 * distributed transaction. The idea is to have a commander, which coordinates the execution of all
 * instructions and ensures proper completion using retries and taking care of idempotence. By
 * queueing instructions while they haven't been done, we can ensure a state of 'eventual
 * consistency'.&lt;/p&gt;
 * &lt;p&gt;In our example, we have an e-commerce application. When the user places an order,
 * the shipping service is intimated first. If the service does not respond for some reason, the
 * order is not placed. If response is received, the commander then calls for the payment service to
 * be intimated. If this fails, the shipping still takes place (order converted to COD) and the item
 * is queued. If the queue is also found to be unavailable, the payment is noted to be not done and
 * this is added to an employee database. Three types of messages are sent to the user - one, if
 * payment succeeds; two, if payment fails definitively; and three, if payment fails in the first
 * attempt. If the message is not sent, this is also queued and is added to employee db. We also
 * have a time limit for each instruction to be completed, after which, the instruction is not
 * executed, thereby ensuring that resources are not held for too long. In the rare occasion in
 * which everything fails, an individual would have to step in to figure out how to solve the
 * issue.&lt;/p&gt;
 * &lt;p&gt;We have abstract classes {@link Database} and {@link Service} which are extended
 * by all the databases and services. Each service has a database to be updated, and receives
 * request from an outside user (the {@link Commander} class here). There are 5 microservices -
 * {@link ShippingService}, {@link PaymentService}, {@link MessagingService}, {@link EmployeeHandle}
 * and a {@link QueueDatabase}. We use retries to execute any instruction using {@link Retry} class,
 * and idempotence is ensured by going through some checks before making requests to services and
 * making change in {@link Order} class fields if request succeeds or definitively fails. There are
 * 5 classes - {@link AppShippingFailCases}, {@link AppPaymentFailCases}, {@link
 * AppMessagingFailCases}, {@link AppQueueFailCases} and {@link AppEmployeeDbFailCases}, which look
 * at the different scenarios that may be encountered during the placing of an order.&lt;/p&gt;
 */

public class Commander {

  private final QueueDatabase queue;
  private final EmployeeHandle employeeDb;
  private final PaymentService paymentService;
  private final ShippingService shippingService;
  private final MessagingService messagingService;
<span class="fc" id="L82">  private int queueItems = 0; //keeping track here only so don't need access to queue db to get this</span>
  private final int numOfRetries;
  private final long retryDuration;
  private final long queueTime;
  private final long queueTaskTime;
  private final long paymentTime;
  private final long messageTime;
  private final long employeeTime;
  private boolean finalSiteMsgShown;
<span class="fc" id="L91">  private static final Logger LOG = LoggerFactory.getLogger(Commander.class);</span>
  //we could also have another db where it stores all orders

  private static final String ORDER_ID = &quot;Order {}&quot;;
  private static final String REQUEST_ID = &quot; request Id: {}&quot;;
  private static final String ERROR_CONNECTING_MSG_SVC =
          &quot;: Error in connecting to messaging service &quot;;
  private static final String TRY_CONNECTING_MSG_SVC =
          &quot;: Trying to connect to messaging service..&quot;;

  Commander(EmployeeHandle empDb, PaymentService paymentService, ShippingService shippingService,
            MessagingService messagingService, QueueDatabase qdb, int numOfRetries,
            long retryDuration, long queueTime, long queueTaskTime, long paymentTime,
<span class="fc" id="L104">            long messageTime, long employeeTime) {</span>
<span class="fc" id="L105">    this.paymentService = paymentService;</span>
<span class="fc" id="L106">    this.shippingService = shippingService;</span>
<span class="fc" id="L107">    this.messagingService = messagingService;</span>
<span class="fc" id="L108">    this.employeeDb = empDb;</span>
<span class="fc" id="L109">    this.queue = qdb;</span>
<span class="fc" id="L110">    this.numOfRetries = numOfRetries;</span>
<span class="fc" id="L111">    this.retryDuration = retryDuration;</span>
<span class="fc" id="L112">    this.queueTime = queueTime;</span>
<span class="fc" id="L113">    this.queueTaskTime = queueTaskTime;</span>
<span class="fc" id="L114">    this.paymentTime = paymentTime;</span>
<span class="fc" id="L115">    this.messageTime = messageTime;</span>
<span class="fc" id="L116">    this.employeeTime = employeeTime;</span>
<span class="fc" id="L117">    this.finalSiteMsgShown = false;</span>
<span class="fc" id="L118">  }</span>

  void placeOrder(Order order) throws Exception {
<span class="fc" id="L121">    sendShippingRequest(order);</span>
<span class="fc" id="L122">  }</span>

  private void sendShippingRequest(Order order) throws Exception {
<span class="fc" id="L125">    var list = shippingService.exceptionsList;</span>
<span class="fc" id="L126">    Retry.Operation op = (l) -&gt; {</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">      if (!l.isEmpty()) {</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (DatabaseUnavailableException.class.isAssignableFrom(l.get(0).getClass())) {</span>
<span class="fc" id="L129">          LOG.debug(ORDER_ID + &quot;: Error in connecting to shipping service, &quot;</span>
              + &quot;trying again..&quot;, order.id);
        } else {
<span class="fc" id="L132">          LOG.debug(ORDER_ID + &quot;: Error in creating shipping request..&quot;, order.id);</span>
        }
<span class="fc" id="L134">        throw l.remove(0);</span>
      }
<span class="fc" id="L136">      String transactionId = shippingService.receiveRequest(order.item, order.user.address);</span>
      //could save this transaction id in a db too
<span class="fc" id="L138">      LOG.info(ORDER_ID + &quot;: Shipping placed successfully, transaction id: {}&quot;,</span>
              order.id, transactionId);
<span class="fc" id="L140">      LOG.info(&quot;Order has been placed and will be shipped to you. Please wait while we make your&quot;</span>
          + &quot; payment... &quot;);
<span class="fc" id="L142">      sendPaymentRequest(order);</span>
<span class="fc" id="L143">    };</span>
<span class="fc" id="L144">    Retry.HandleErrorIssue&lt;Order&gt; handleError = (o, err) -&gt; {</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">      if (ShippingNotPossibleException.class.isAssignableFrom(err.getClass())) {</span>
<span class="fc" id="L146">        LOG.info(&quot;Shipping is currently not possible to your address. We are working on the problem&quot;</span>
            + &quot; and will get back to you asap.&quot;);
<span class="fc" id="L148">        finalSiteMsgShown = true;</span>
<span class="fc" id="L149">        LOG.info(ORDER_ID + &quot;: Shipping not possible to address, trying to add problem &quot;</span>
            + &quot;to employee db..&quot;, order.id);
<span class="fc" id="L151">        employeeHandleIssue(o);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">      } else if (ItemUnavailableException.class.isAssignableFrom(err.getClass())) {</span>
<span class="fc" id="L153">        LOG.info(&quot;This item is currently unavailable. We will inform you as soon as the item &quot;</span>
            + &quot;becomes available again.&quot;);
<span class="fc" id="L155">        finalSiteMsgShown = true;</span>
<span class="fc" id="L156">        LOG.info(ORDER_ID + &quot;: Item {}&quot; + &quot; unavailable, trying to add &quot;</span>
            + &quot;problem to employee handle..&quot;, order.id, order.item);
<span class="fc" id="L158">        employeeHandleIssue(o);</span>
      } else {
<span class="fc" id="L160">        LOG.info(&quot;Sorry, there was a problem in creating your order. Please try later.&quot;);</span>
<span class="fc" id="L161">        LOG.error(ORDER_ID + &quot;: Shipping service unavailable, order not placed..&quot;, order.id);</span>
<span class="fc" id="L162">        finalSiteMsgShown = true;</span>
      }
<span class="fc" id="L164">    };</span>
<span class="fc" id="L165">    var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L166">        e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
<span class="fc" id="L167">    r.perform(list, order);</span>
<span class="fc" id="L168">  }</span>

  private void sendPaymentRequest(Order order) {
<span class="fc bfc" id="L171" title="All 2 branches covered.">    if (System.currentTimeMillis() - order.createdTime &gt;= this.paymentTime) {</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">      if (order.paid.equals(PaymentStatus.TRYING)) {</span>
<span class="fc" id="L173">        order.paid = PaymentStatus.NOT_DONE;</span>
<span class="fc" id="L174">        sendPaymentFailureMessage(order);</span>
<span class="fc" id="L175">        LOG.error(ORDER_ID + &quot;: Payment time for order over, failed and returning..&quot;, order.id);</span>
      } //if succeeded or failed, would have been dequeued, no attempt to make payment     
<span class="fc" id="L177">      return;</span>
    }
<span class="fc" id="L179">    var list = paymentService.exceptionsList;</span>
<span class="fc" id="L180">    var t = new Thread(() -&gt; {</span>
<span class="fc" id="L181">      Retry.Operation op = (l) -&gt; {</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (!l.isEmpty()) {</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">          if (DatabaseUnavailableException.class.isAssignableFrom(l.get(0).getClass())) {</span>
<span class="fc" id="L184">            LOG.debug(ORDER_ID + &quot;: Error in connecting to payment service,&quot;</span>
                + &quot; trying again..&quot;, order.id);
          } else {
<span class="fc" id="L187">            LOG.debug(ORDER_ID + &quot;: Error in creating payment request..&quot;, order.id);</span>
          }
<span class="fc" id="L189">          throw l.remove(0);</span>
        }
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (order.paid.equals(PaymentStatus.TRYING)) {</span>
<span class="fc" id="L192">          var transactionId = paymentService.receiveRequest(order.price);</span>
<span class="fc" id="L193">          order.paid = PaymentStatus.DONE;</span>
<span class="fc" id="L194">          LOG.info(ORDER_ID + &quot;: Payment successful, transaction Id: {}&quot;,</span>
                  order.id, transactionId);
<span class="fc bfc" id="L196" title="All 2 branches covered.">          if (!finalSiteMsgShown) {</span>
<span class="fc" id="L197">            LOG.info(&quot;Payment made successfully, thank you for shopping with us!!&quot;);</span>
<span class="fc" id="L198">            finalSiteMsgShown = true;</span>
          }
<span class="fc" id="L200">          sendSuccessMessage(order);</span>
        }
<span class="fc" id="L202">      };</span>
<span class="fc" id="L203">      Retry.HandleErrorIssue&lt;Order&gt; handleError = (o, err) -&gt; {</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (PaymentDetailsErrorException.class.isAssignableFrom(err.getClass())) {</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">          if (!finalSiteMsgShown) {</span>
<span class="nc" id="L206">            LOG.info(&quot;There was an error in payment. Your account/card details &quot;</span>
                + &quot;may have been incorrect. &quot;
                + &quot;Meanwhile, your order has been converted to COD and will be shipped.&quot;);
<span class="nc" id="L209">            finalSiteMsgShown = true;</span>
          }
<span class="fc" id="L211">          LOG.error(ORDER_ID + &quot;: Payment details incorrect, failed..&quot;, order.id);</span>
<span class="fc" id="L212">          o.paid = PaymentStatus.NOT_DONE;</span>
<span class="fc" id="L213">          sendPaymentFailureMessage(o);</span>
        } else {
<span class="fc bfc" id="L215" title="All 2 branches covered.">          if (o.messageSent.equals(MessageSent.NONE_SENT)) {</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (!finalSiteMsgShown) {</span>
<span class="fc" id="L217">              LOG.info(&quot;There was an error in payment. We are on it, and will get back to you &quot;</span>
                  + &quot;asap. Don't worry, your order has been placed and will be shipped.&quot;);
<span class="fc" id="L219">              finalSiteMsgShown = true;</span>
            }
<span class="fc" id="L221">            LOG.warn(ORDER_ID + &quot;: Payment error, going to queue..&quot;, order.id);</span>
<span class="fc" id="L222">            sendPaymentPossibleErrorMsg(o);</span>
          }
<span class="fc bfc" id="L224" title="All 2 branches covered.">          if (o.paid.equals(PaymentStatus.TRYING) &amp;&amp; System</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">              .currentTimeMillis() - o.createdTime &lt; paymentTime) {</span>
<span class="fc" id="L226">            var qt = new QueueTask(o, TaskType.PAYMENT, -1);</span>
<span class="fc" id="L227">            updateQueue(qt);</span>
          }
        }
<span class="fc" id="L230">      };</span>
<span class="fc" id="L231">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L232">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L234">        r.perform(list, order);</span>
<span class="fc" id="L235">      } catch (Exception e1) {</span>
<span class="fc" id="L236">        e1.printStackTrace();</span>
<span class="fc" id="L237">      }</span>
<span class="fc" id="L238">    });</span>
<span class="fc" id="L239">    t.start();</span>
<span class="fc" id="L240">  }</span>

  private void updateQueue(QueueTask qt) {
<span class="fc bfc" id="L243" title="All 2 branches covered.">    if (System.currentTimeMillis() - qt.order.createdTime &gt;= this.queueTime) {</span>
      // since payment time is lesser than queuetime it would have already failed..
      // additional check not needed
<span class="fc" id="L246">      LOG.trace(ORDER_ID + &quot;: Queue time for order over, failed..&quot;, qt.order.id);</span>
<span class="fc" id="L247">      return;</span>
<span class="fc bfc" id="L248" title="All 4 branches covered.">    } else if (qt.taskType.equals(TaskType.PAYMENT) &amp;&amp; !qt.order.paid.equals(PaymentStatus.TRYING)</span>
<span class="fc bfc" id="L249" title="All 4 branches covered.">        || qt.taskType.equals(TaskType.MESSAGING) &amp;&amp; (qt.messageType == 1</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        &amp;&amp; !qt.order.messageSent.equals(MessageSent.NONE_SENT)</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        || qt.order.messageSent.equals(MessageSent.PAYMENT_FAIL)</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">        || qt.order.messageSent.equals(MessageSent.PAYMENT_SUCCESSFUL))</span>
<span class="pc bpc" id="L253" title="1 of 4 branches missed.">        || qt.taskType.equals(TaskType.EMPLOYEE_DB) &amp;&amp; qt.order.addedToEmployeeHandle) {</span>
<span class="fc" id="L254">      LOG.trace(ORDER_ID + &quot;: Not queueing task since task already done..&quot;, qt.order.id);</span>
<span class="fc" id="L255">      return;</span>
    }
<span class="fc" id="L257">    var list = queue.exceptionsList;</span>
<span class="fc" id="L258">    Thread t = new Thread(() -&gt; {</span>
<span class="fc" id="L259">      Retry.Operation op = (list1) -&gt; {</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (!list1.isEmpty()) {</span>
<span class="fc" id="L261">          LOG.warn(ORDER_ID + &quot;: Error in connecting to queue db, trying again..&quot;, qt.order.id);</span>
<span class="fc" id="L262">          throw list1.remove(0);</span>
        }
<span class="fc" id="L264">        queue.add(qt);</span>
<span class="fc" id="L265">        queueItems++;</span>
<span class="fc" id="L266">        LOG.info(ORDER_ID + &quot;: {}&quot; + &quot; task enqueued..&quot;, qt.order.id, qt.getType());</span>
<span class="fc" id="L267">        tryDoingTasksInQueue();</span>
<span class="fc" id="L268">      };</span>
<span class="fc" id="L269">      Retry.HandleErrorIssue&lt;QueueTask&gt; handleError = (qt1, err) -&gt; {</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">        if (qt1.taskType.equals(TaskType.PAYMENT)) {</span>
<span class="fc" id="L271">          qt1.order.paid = PaymentStatus.NOT_DONE;</span>
<span class="fc" id="L272">          sendPaymentFailureMessage(qt1.order);</span>
<span class="fc" id="L273">          LOG.error(ORDER_ID + &quot;: Unable to enqueue payment task,&quot;</span>
              + &quot; payment failed..&quot;, qt1.order.id);
        }
<span class="fc" id="L276">        LOG.error(ORDER_ID + &quot;: Unable to enqueue task of type {}&quot;</span>
<span class="fc" id="L277">                + &quot;, trying to add to employee handle..&quot;, qt1.order.id, qt1.getType());</span>
<span class="fc" id="L278">        employeeHandleIssue(qt1.order);</span>
<span class="fc" id="L279">      };</span>
<span class="fc" id="L280">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L281">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L283">        r.perform(list, qt);</span>
<span class="nc" id="L284">      } catch (Exception e1) {</span>
<span class="nc" id="L285">        e1.printStackTrace();</span>
<span class="fc" id="L286">      }</span>
<span class="fc" id="L287">    });</span>
<span class="fc" id="L288">    t.start();</span>
<span class="fc" id="L289">  }</span>

  private void tryDoingTasksInQueue() { //commander controls operations done to queue
<span class="fc" id="L292">    var list = queue.exceptionsList;</span>
<span class="fc" id="L293">    var t2 = new Thread(() -&gt; {</span>
<span class="fc" id="L294">      Retry.Operation op = (list1) -&gt; {</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">        if (!list1.isEmpty()) {</span>
<span class="nc" id="L296">          LOG.warn(&quot;Error in accessing queue db to do tasks, trying again..&quot;);</span>
<span class="nc" id="L297">          throw list1.remove(0);</span>
        }
<span class="fc" id="L299">        doTasksInQueue();</span>
<span class="fc" id="L300">      };</span>
<span class="fc" id="L301">      Retry.HandleErrorIssue&lt;QueueTask&gt; handleError = (o, err) -&gt; {</span>
<span class="fc" id="L302">      };</span>
<span class="fc" id="L303">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L304">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L306">        r.perform(list, null);</span>
<span class="nc" id="L307">      } catch (Exception e1) {</span>
<span class="nc" id="L308">        e1.printStackTrace();</span>
<span class="fc" id="L309">      }</span>
<span class="fc" id="L310">    });</span>
<span class="fc" id="L311">    t2.start();</span>
<span class="fc" id="L312">  }</span>

  private void tryDequeue() {
<span class="fc" id="L315">    var list = queue.exceptionsList;</span>
<span class="fc" id="L316">    var t3 = new Thread(() -&gt; {</span>
<span class="fc" id="L317">      Retry.Operation op = (list1) -&gt; {</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">        if (!list1.isEmpty()) {</span>
<span class="nc" id="L319">          LOG.warn(&quot;Error in accessing queue db to dequeue task, trying again..&quot;);</span>
<span class="nc" id="L320">          throw list1.remove(0);</span>
        }
<span class="fc" id="L322">        queue.dequeue();</span>
<span class="fc" id="L323">        queueItems--;</span>
<span class="fc" id="L324">      };</span>
<span class="fc" id="L325">      Retry.HandleErrorIssue&lt;QueueTask&gt; handleError = (o, err) -&gt; {</span>
<span class="fc" id="L326">      };</span>
<span class="fc" id="L327">      var r = new Retry&lt;QueueTask&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L328">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L330">        r.perform(list, null);</span>
<span class="nc" id="L331">      } catch (Exception e1) {</span>
<span class="nc" id="L332">        e1.printStackTrace();</span>
<span class="fc" id="L333">      }</span>
<span class="fc" id="L334">    });</span>
<span class="fc" id="L335">    t3.start();</span>
<span class="fc" id="L336">  }</span>

  private void sendSuccessMessage(Order order) {
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">    if (System.currentTimeMillis() - order.createdTime &gt;= this.messageTime) {</span>
<span class="nc" id="L340">      LOG.trace(ORDER_ID + &quot;: Message time for order over, returning..&quot;, order.id);</span>
<span class="nc" id="L341">      return;</span>
    }
<span class="fc" id="L343">    var list = messagingService.exceptionsList;</span>
<span class="fc" id="L344">    Thread t = new Thread(() -&gt; {</span>
<span class="fc" id="L345">      Retry.Operation op = handleSuccessMessageRetryOperation(order);</span>
<span class="fc" id="L346">      Retry.HandleErrorIssue&lt;Order&gt; handleError = (o, err) -&gt; {</span>
<span class="fc" id="L347">        handleSuccessMessageErrorIssue(order, o);</span>
<span class="fc" id="L348">      };</span>
<span class="fc" id="L349">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L350">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L352">        r.perform(list, order);</span>
<span class="fc" id="L353">      } catch (Exception e1) {</span>
<span class="fc" id="L354">        e1.printStackTrace();</span>
<span class="fc" id="L355">      }</span>
<span class="fc" id="L356">    });</span>
<span class="fc" id="L357">    t.start();</span>
<span class="fc" id="L358">  }</span>

  private void handleSuccessMessageErrorIssue(Order order, Order o) {
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">    if ((o.messageSent.equals(MessageSent.NONE_SENT) || o.messageSent</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">        .equals(MessageSent.PAYMENT_TRYING))</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">        &amp;&amp; System.currentTimeMillis() - o.createdTime &lt; messageTime) {</span>
<span class="fc" id="L364">      var qt = new QueueTask(order, TaskType.MESSAGING, 2);</span>
<span class="fc" id="L365">      updateQueue(qt);</span>
<span class="fc" id="L366">      LOG.info(ORDER_ID + &quot;: Error in sending Payment Success message, trying to&quot;</span>
          + &quot; queue task and add to employee handle..&quot;, order.id);
<span class="fc" id="L368">      employeeHandleIssue(order);</span>
    }
<span class="fc" id="L370">  }</span>

  private Retry.Operation handleSuccessMessageRetryOperation(Order order) {
<span class="fc" id="L373">    return (l) -&gt; {</span>
<span class="fc bfc" id="L374" title="All 2 branches covered.">      if (!l.isEmpty()) {</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">        if (DatabaseUnavailableException.class.isAssignableFrom(l.get(0).getClass())) {</span>
<span class="fc" id="L376">          LOG.debug(ORDER_ID + ERROR_CONNECTING_MSG_SVC</span>
              + &quot;(Payment Success msg), trying again..&quot;, order.id);
        } else {
<span class="fc" id="L379">          LOG.debug(ORDER_ID + &quot;: Error in creating Payment Success&quot;</span>
              + &quot; messaging request..&quot;, order.id);
        }
<span class="fc" id="L382">        throw l.remove(0);</span>
      }
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">      if (!order.messageSent.equals(MessageSent.PAYMENT_FAIL)</span>
<span class="fc bfc" id="L385" title="All 2 branches covered.">          &amp;&amp; !order.messageSent.equals(MessageSent.PAYMENT_SUCCESSFUL)) {</span>
<span class="fc" id="L386">        var requestId = messagingService.receiveRequest(2);</span>
<span class="fc" id="L387">        order.messageSent = MessageSent.PAYMENT_SUCCESSFUL;</span>
<span class="fc" id="L388">        LOG.info(ORDER_ID + &quot;: Payment Success message sent,&quot;</span>
            + REQUEST_ID, order.id, requestId);
      }
<span class="fc" id="L391">    };</span>
  }

  private void sendPaymentFailureMessage(Order order) {
<span class="fc bfc" id="L395" title="All 2 branches covered.">    if (System.currentTimeMillis() - order.createdTime &gt;= this.messageTime) {</span>
<span class="fc" id="L396">      LOG.trace(ORDER_ID + &quot;: Message time for order over, returning..&quot;, order.id);</span>
<span class="fc" id="L397">      return;</span>
    }
<span class="fc" id="L399">    var list = messagingService.exceptionsList;</span>
<span class="fc" id="L400">    var t = new Thread(() -&gt; {</span>
<span class="fc" id="L401">      Retry.Operation op = (l) -&gt; {</span>
<span class="fc" id="L402">        handlePaymentFailureRetryOperation(order, l);</span>
<span class="fc" id="L403">      };</span>
<span class="fc" id="L404">      Retry.HandleErrorIssue&lt;Order&gt; handleError = (o, err) -&gt; {</span>
<span class="fc" id="L405">        handlePaymentErrorIssue(order, o);</span>
<span class="fc" id="L406">      };</span>
<span class="fc" id="L407">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L408">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L410">        r.perform(list, order);</span>
<span class="fc" id="L411">      } catch (Exception e1) {</span>
<span class="fc" id="L412">        e1.printStackTrace();</span>
<span class="fc" id="L413">      }</span>
<span class="fc" id="L414">    });</span>
<span class="fc" id="L415">    t.start();</span>
<span class="fc" id="L416">  }</span>

  private void handlePaymentErrorIssue(Order order, Order o) {
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">    if ((o.messageSent.equals(MessageSent.NONE_SENT) || o.messageSent</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">        .equals(MessageSent.PAYMENT_TRYING))</span>
<span class="pc bpc" id="L421" title="1 of 2 branches missed.">        &amp;&amp; System.currentTimeMillis() - o.createdTime &lt; messageTime) {</span>
<span class="fc" id="L422">      var qt = new QueueTask(order, TaskType.MESSAGING, 0);</span>
<span class="fc" id="L423">      updateQueue(qt);</span>
<span class="fc" id="L424">      LOG.warn(ORDER_ID + &quot;: Error in sending Payment Failure message, &quot;</span>
              + &quot;trying to queue task and add to employee handle..&quot;, order.id);
<span class="fc" id="L426">      employeeHandleIssue(o);</span>
    }
<span class="fc" id="L428">  }</span>

  private void handlePaymentFailureRetryOperation(Order order, List&lt;Exception&gt; l) throws Exception {
<span class="fc bfc" id="L431" title="All 2 branches covered.">    if (!l.isEmpty()) {</span>
<span class="fc bfc" id="L432" title="All 2 branches covered.">      if (DatabaseUnavailableException.class.isAssignableFrom(l.get(0).getClass())) {</span>
<span class="fc" id="L433">        LOG.debug(ORDER_ID + ERROR_CONNECTING_MSG_SVC</span>
            + &quot;(Payment Failure msg), trying again..&quot;, order.id);
      } else {
<span class="fc" id="L436">        LOG.debug(ORDER_ID + &quot;: Error in creating Payment Failure&quot;</span>
            + &quot; message request..&quot;, order.id);
      }
<span class="fc" id="L439">      throw l.remove(0);</span>
    }
<span class="fc bfc" id="L441" title="All 2 branches covered.">    if (!order.messageSent.equals(MessageSent.PAYMENT_FAIL)</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">        &amp;&amp; !order.messageSent.equals(MessageSent.PAYMENT_SUCCESSFUL)) {</span>
<span class="fc" id="L443">      var requestId = messagingService.receiveRequest(0);</span>
<span class="fc" id="L444">      order.messageSent = MessageSent.PAYMENT_FAIL;</span>
<span class="fc" id="L445">      LOG.info(ORDER_ID + &quot;: Payment Failure message sent successfully,&quot;</span>
          + REQUEST_ID, order.id, requestId);
    }
<span class="fc" id="L448">  }</span>

  private void sendPaymentPossibleErrorMsg(Order order) {
<span class="fc bfc" id="L451" title="All 2 branches covered.">    if (System.currentTimeMillis() - order.createdTime &gt;= this.messageTime) {</span>
<span class="fc" id="L452">      LOG.trace(&quot;Message time for order over, returning..&quot;);</span>
<span class="fc" id="L453">      return;</span>
    }
<span class="fc" id="L455">    var list = messagingService.exceptionsList;</span>
<span class="fc" id="L456">    var t = new Thread(() -&gt; {</span>
<span class="fc" id="L457">      Retry.Operation op = (l) -&gt; {</span>
<span class="fc" id="L458">        handlePaymentPossibleErrorMsgRetryOperation(order, l);</span>
<span class="fc" id="L459">      };</span>
<span class="fc" id="L460">      Retry.HandleErrorIssue&lt;Order&gt; handleError = (o, err) -&gt; {</span>
<span class="fc" id="L461">        handlePaymentPossibleErrorMsgErrorIssue(order, o);</span>
<span class="fc" id="L462">      };</span>
<span class="fc" id="L463">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L464">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L466">        r.perform(list, order);</span>
<span class="fc" id="L467">      } catch (Exception e1) {</span>
<span class="fc" id="L468">        e1.printStackTrace();</span>
<span class="fc" id="L469">      }</span>
<span class="fc" id="L470">    });</span>
<span class="fc" id="L471">    t.start();</span>
<span class="fc" id="L472">  }</span>

  private void handlePaymentPossibleErrorMsgErrorIssue(Order order, Order o) {
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">    if (o.messageSent.equals(MessageSent.NONE_SENT) &amp;&amp; order.paid</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">        .equals(PaymentStatus.TRYING)</span>
<span class="pc bpc" id="L477" title="1 of 2 branches missed.">        &amp;&amp; System.currentTimeMillis() - o.createdTime &lt; messageTime) {</span>
<span class="fc" id="L478">      var qt = new QueueTask(order, TaskType.MESSAGING, 1);</span>
<span class="fc" id="L479">      updateQueue(qt);</span>
<span class="fc" id="L480">      LOG.warn(&quot;Order {}: Error in sending Payment Error message, trying to queue task and add to employee handle..&quot;,</span>
              order.id);
<span class="fc" id="L482">      employeeHandleIssue(o);</span>
    }
<span class="fc" id="L484">  }</span>

  private void handlePaymentPossibleErrorMsgRetryOperation(Order order, List&lt;Exception&gt; l)
      throws Exception {
<span class="fc bfc" id="L488" title="All 2 branches covered.">    if (!l.isEmpty()) {</span>
<span class="fc bfc" id="L489" title="All 2 branches covered.">      if (DatabaseUnavailableException.class.isAssignableFrom(l.get(0).getClass())) {</span>
<span class="fc" id="L490">        LOG.debug(ORDER_ID + ERROR_CONNECTING_MSG_SVC</span>
            + &quot;(Payment Error msg), trying again..&quot;, order.id);
      } else {
<span class="fc" id="L493">        LOG.debug(ORDER_ID + &quot;: Error in creating Payment Error&quot;</span>
            + &quot; messaging request..&quot;, order.id);
      }
<span class="fc" id="L496">      throw l.remove(0);</span>
    }
<span class="fc bfc" id="L498" title="All 2 branches covered.">    if (order.paid.equals(PaymentStatus.TRYING) &amp;&amp; order.messageSent</span>
<span class="fc bfc" id="L499" title="All 2 branches covered.">        .equals(MessageSent.NONE_SENT)) {</span>
<span class="fc" id="L500">      var requestId = messagingService.receiveRequest(1);</span>
<span class="fc" id="L501">      order.messageSent = MessageSent.PAYMENT_TRYING;</span>
<span class="fc" id="L502">      LOG.info(ORDER_ID + &quot;: Payment Error message sent successfully,&quot;</span>
          + REQUEST_ID, order.id, requestId);
    }
<span class="fc" id="L505">  }</span>

  private void employeeHandleIssue(Order order) {
<span class="fc bfc" id="L508" title="All 2 branches covered.">    if (System.currentTimeMillis() - order.createdTime &gt;= this.employeeTime) {</span>
<span class="fc" id="L509">      LOG.trace(ORDER_ID + &quot;: Employee handle time for order over, returning..&quot;, order.id);</span>
<span class="fc" id="L510">      return;</span>
    }
<span class="fc" id="L512">    var list = employeeDb.exceptionsList;</span>
<span class="fc" id="L513">    var t = new Thread(() -&gt; {</span>
<span class="fc" id="L514">      Retry.Operation op = (l) -&gt; {</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">        if (!l.isEmpty()) {</span>
<span class="fc" id="L516">          LOG.warn(ORDER_ID + &quot;: Error in connecting to employee handle,&quot;</span>
              + &quot; trying again..&quot;, order.id);
<span class="fc" id="L518">          throw l.remove(0);</span>
        }
<span class="fc bfc" id="L520" title="All 2 branches covered.">        if (!order.addedToEmployeeHandle) {</span>
<span class="fc" id="L521">          employeeDb.receiveRequest(order);</span>
<span class="fc" id="L522">          order.addedToEmployeeHandle = true;</span>
<span class="fc" id="L523">          LOG.info(ORDER_ID + &quot;: Added order to employee database&quot;, order.id);</span>
        }
<span class="fc" id="L525">      };</span>
<span class="fc" id="L526">      Retry.HandleErrorIssue&lt;Order&gt; handleError = (o, err) -&gt; {</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">        if (!o.addedToEmployeeHandle &amp;&amp; System</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">            .currentTimeMillis() - order.createdTime &lt; employeeTime) {</span>
<span class="fc" id="L529">          var qt = new QueueTask(order, TaskType.EMPLOYEE_DB, -1);</span>
<span class="fc" id="L530">          updateQueue(qt);</span>
<span class="fc" id="L531">          LOG.warn(ORDER_ID + &quot;: Error in adding to employee db,&quot;</span>
              + &quot; trying to queue task..&quot;, order.id);
        }
<span class="fc" id="L534">      };</span>
<span class="fc" id="L535">      var r = new Retry&lt;&gt;(op, handleError, numOfRetries, retryDuration,</span>
<span class="nc" id="L536">          e -&gt; DatabaseUnavailableException.class.isAssignableFrom(e.getClass()));</span>
      try {
<span class="fc" id="L538">        r.perform(list, order);</span>
<span class="fc" id="L539">      } catch (Exception e1) {</span>
<span class="fc" id="L540">        e1.printStackTrace();</span>
<span class="fc" id="L541">      }</span>
<span class="fc" id="L542">    });</span>
<span class="fc" id="L543">    t.start();</span>
<span class="fc" id="L544">  }</span>

  private void doTasksInQueue() throws Exception {
<span class="fc bfc" id="L547" title="All 2 branches covered.">    if (queueItems != 0) {</span>
<span class="fc" id="L548">      var qt = queue.peek(); //this should probably be cloned here</span>
      //this is why we have retry for doTasksInQueue
<span class="fc" id="L550">      LOG.trace(ORDER_ID + &quot;: Started doing task of type {}&quot;, qt.order.id, qt.getType());</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">      if (qt.getFirstAttemptTime() == -1) {</span>
<span class="fc" id="L552">        qt.setFirstAttemptTime(System.currentTimeMillis());</span>
      }
<span class="fc bfc" id="L554" title="All 2 branches covered.">      if (System.currentTimeMillis() - qt.getFirstAttemptTime() &gt;= queueTaskTime) {</span>
<span class="fc" id="L555">        tryDequeue();</span>
<span class="fc" id="L556">        LOG.trace(ORDER_ID + &quot;: This queue task of type {}&quot;</span>
<span class="fc" id="L557">            + &quot; does not need to be done anymore (timeout), dequeue..&quot;, qt.order.id, qt.getType());</span>
      } else {
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">        if (qt.taskType.equals(TaskType.PAYMENT)) {</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">          if (!qt.order.paid.equals(PaymentStatus.TRYING)) {</span>
<span class="nc" id="L561">            tryDequeue();</span>
<span class="nc" id="L562">            LOG.trace(ORDER_ID + &quot;: This payment task already done, dequeueing..&quot;, qt.order.id);</span>
          } else {
<span class="nc" id="L564">            sendPaymentRequest(qt.order);</span>
<span class="nc" id="L565">            LOG.debug(ORDER_ID + &quot;: Trying to connect to payment service..&quot;, qt.order.id);</span>
          }
<span class="pc bpc" id="L567" title="1 of 2 branches missed.">        } else if (qt.taskType.equals(TaskType.MESSAGING)) {</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">          if (qt.order.messageSent.equals(MessageSent.PAYMENT_FAIL)</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">              || qt.order.messageSent.equals(MessageSent.PAYMENT_SUCCESSFUL)) {</span>
<span class="nc" id="L570">            tryDequeue();</span>
<span class="nc" id="L571">            LOG.trace(ORDER_ID + &quot;: This messaging task already done, dequeue..&quot;, qt.order.id);</span>
<span class="nc bnc" id="L572" title="All 4 branches missed.">          } else if (qt.messageType == 1 &amp;&amp; (!qt.order.messageSent.equals(MessageSent.NONE_SENT)</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">              || !qt.order.paid.equals(PaymentStatus.TRYING))) {</span>
<span class="nc" id="L574">            tryDequeue();</span>
<span class="nc" id="L575">            LOG.trace(ORDER_ID + &quot;: This messaging task does not need to be done,&quot;</span>
                + &quot; dequeue..&quot;, qt.order.id);
<span class="nc bnc" id="L577" title="All 2 branches missed.">          } else if (qt.messageType == 0) {</span>
<span class="nc" id="L578">            sendPaymentFailureMessage(qt.order);</span>
<span class="nc" id="L579">            LOG.debug(ORDER_ID + TRY_CONNECTING_MSG_SVC, qt.order.id);</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">          } else if (qt.messageType == 1) {</span>
<span class="nc" id="L581">            sendPaymentPossibleErrorMsg(qt.order);</span>
<span class="nc" id="L582">            LOG.debug(ORDER_ID + TRY_CONNECTING_MSG_SVC, qt.order.id);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">          } else if (qt.messageType == 2) {</span>
<span class="nc" id="L584">            sendSuccessMessage(qt.order);</span>
<span class="nc" id="L585">            LOG.debug(ORDER_ID + TRY_CONNECTING_MSG_SVC, qt.order.id);</span>
          }
<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        } else if (qt.taskType.equals(TaskType.EMPLOYEE_DB)) {</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">          if (qt.order.addedToEmployeeHandle) {</span>
<span class="fc" id="L589">            tryDequeue();</span>
<span class="fc" id="L590">            LOG.trace(ORDER_ID + &quot;: This employee handle task already done,&quot;</span>
                + &quot; dequeue..&quot;, qt.order.id);
          } else {
<span class="fc" id="L593">            employeeHandleIssue(qt.order);</span>
<span class="fc" id="L594">            LOG.debug(ORDER_ID + &quot;: Trying to connect to employee handle..&quot;, qt.order.id);</span>
          }
        }
      }
    }
<span class="fc bfc" id="L599" title="All 2 branches covered.">    if (queueItems == 0) {</span>
<span class="fc" id="L600">      LOG.trace(&quot;Queue is empty, returning..&quot;);</span>
    } else {
<span class="fc" id="L602">      Thread.sleep(queueTaskTime / 3);</span>
<span class="fc" id="L603">      tryDoingTasksInQueue();</span>
    }
<span class="fc" id="L605">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>